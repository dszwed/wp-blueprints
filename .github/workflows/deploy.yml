name: Deploy Laravel Application

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build Application
    uses: ./.github/workflows/build.yml

  test:
    name: Run Tests
    needs: build
    uses: ./.github/workflows/test.yml
    with:
      app_built: true

  deploy:
    runs-on: ubuntu-latest
    needs: [build, test]
    name: Deploy to Production
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v3

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ github.sha }}
          path: ./artifacts

      - name: Deploy to production server
        run: |
          echo "ğŸš€ Starting deployment to production server..."
          echo "ğŸ“¦ Extracting build artifacts..."
          echo "ğŸ”„ Uploading files to server..."
          echo "ğŸ”§ Running deployment scripts..."
          echo "ğŸ—ƒï¸  Running database migrations..."
          echo "ğŸ§¹ Clearing application cache..."
          echo "âœ… Deployment to production completed successfully!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ Application successfully deployed to production!"
            echo "ğŸŒ Application is now live and accessible to users"
          else
            echo "âŒ Deployment failed!"
            echo "ğŸ” Please check the logs for more details"
          fi
